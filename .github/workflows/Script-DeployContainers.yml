name: Script Deploy Container
on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the code
        uses: actions/checkout@v3

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Crear carpeta remota del proyecto si no existe
        run: |
          ssh -o StrictHostKeyChecking=no -p 5122 deploy@sylvahabitat.duckdns.org "mkdir -p ${{ vars.DATA_PATH }}"

      - name: Generar archivo .env desde variables y secrets
        run: |
          mkdir -p ./docker
          echo "DATA_PATH=${{ vars.DATA_PATH }}" > ./docker/.env
          echo "NETWORK_NAME=${{ vars.NETWORK_NAME }}" >> ./docker/.env
          echo "MYSQL_DATABASE=${{ vars.MYSQL_DATABASE }}" >> ./docker/.env
          echo "MYSQL_USER=${{ vars.MYSQL_USER }}" >> ./docker/.env
          echo "MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}" >> ./docker/.env
          echo "MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}" >> ./docker/.env
          echo "PUID=${{ vars.PUID }}" >> ./docker/.env
          echo "PGID=${{ vars.PGID }}" >> ./docker/.env
          echo "TZ=${{ vars.TZ }}" >> ./docker/.env

      - name: Verificar archivos generados
        run: |
          ls -lh ./docker
          echo "Contenido del .env:"
          cat ./docker/.env

      - name: Copiar archivos al servidor remoto
        run: |
          scp -P 5122 -o StrictHostKeyChecking=no ./docker/docker-compose.yml deploy@sylvahabitat.duckdns.org:${{ vars.DATA_PATH }}
          scp -P 5122 -o StrictHostKeyChecking=no ./docker/.env deploy@sylvahabitat.duckdns.org:${{ vars.DATA_PATH }}
          ssh -o StrictHostKeyChecking=no -p 5122 deploy@sylvahabitat.duckdns.org "chmod 600 ${{ vars.DATA_PATH }}/.env"

      - name: Desplegar en servidor remoto
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: sylvahabitat.duckdns.org
          username: deploy
          port: 5122
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ vars.DATA_PATH }}
            docker compose --env-file .env -f docker-compose.yml up -d --build
